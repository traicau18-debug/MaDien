<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng mạ điện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; }
        .canvas-container {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center py-8">

    <div class="max-w-4xl w-full px-4">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800 mb-2">Mô phỏng thí gghiệm mạ điện</h1>
            <p class="text-slate-600">Mạ đồng lên chìa khóa (Điện phân dung dịch CuSO<sub>4</sub>)</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Simulation Canvas Area -->
            <div class="lg:col-span-2 bg-white p-4 rounded-xl border border-slate-200 canvas-container relative">
                <canvas id="simCanvas" width="600" height="450" class="w-full h-auto bg-white rounded-lg cursor-pointer"></canvas>
                
                <!-- Overlay Labels -->
                <div class="absolute top-10 left-10 bg-white/90 px-2 py-1 rounded shadow text-xs font-bold text-red-600 border border-red-200">
                    Anode (+)<br>Thanh Đồng
                </div>
                <div class="absolute top-10 right-10 bg-white/90 px-2 py-1 rounded shadow text-xs font-bold text-slate-700 border border-slate-200">
                    Cathode (-)<br>Chìa Khóa
                </div>
                 <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-blue-100/90 px-3 py-1 rounded shadow text-xs font-bold text-blue-800 border border-blue-200">
                    Dung dịch CuSO<sub>4</sub>
                </div>
            </div>

            <!-- Controls & Info Panel -->
            <div class="flex flex-col gap-4">
                <!-- Control Panel -->
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Bảng Điều Khiển
                    </h2>
                    
                    <div class="flex gap-2 mb-4">
                        <button id="btnStart" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium transition-colors shadow-sm">
                            Bắt đầu
                        </button>
                        <button id="btnReset" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white py-2 px-4 rounded-lg font-medium transition-colors shadow-sm">
                            Làm lại
                        </button>
                    </div>

                    <div class="mb-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Cường độ dòng điện (Tốc độ mạ)</label>
                        <input type="range" id="currentRange" min="1" max="10" value="5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>Thấp</span>
                            <span id="currentVal">5A</span>
                            <span>Cao</span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-slate-50 rounded border border-slate-200">
                        <div class="text-xs font-semibold text-slate-500 uppercase mb-1">Trạng thái</div>
                        <div id="statusText" class="text-sm font-bold text-slate-800">Sẵn sàng...</div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                            <div id="progressBar" class="bg-orange-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="text-right text-xs text-slate-500 mt-1" id="progressText">0%</div>
                    </div>
                </div>

                <!-- Theory Panel -->
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm flex-1">
                    <h2 class="font-bold text-lg text-blue-900 mb-3">Phương trình hóa học</h2>
                    
                    <div class="space-y-3 text-sm">
                        <div>
                            <span class="font-bold text-red-600">Tại Anode (+):</span>
                            <p class="font-mono bg-white p-2 rounded border border-blue-100 mt-1">Cu &rarr; Cu<sup>2+</sup> + 2e<sup>-</sup></p>
                            <p class="text-slate-600 text-xs mt-1 italic">Thanh đồng bị oxi hóa và tan dần vào dung dịch.</p>
                        </div>
                        <div>
                            <span class="font-bold text-slate-700">Tại Cathode (-):</span>
                            <p class="font-mono bg-white p-2 rounded border border-blue-100 mt-1">Cu<sup>2+</sup> + 2e<sup>-</sup> &rarr; Cu</p>
                            <p class="text-slate-600 text-xs mt-1 italic">Ion đồng bị khử và bám vào bề mặt chìa khóa.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const btnStart = document.getElementById('btnStart');
        const btnReset = document.getElementById('btnReset');
        const rangeCurrent = document.getElementById('currentRange');
        const currentValDisplay = document.getElementById('currentVal');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // State variables
        let isRunning = false;
        let progress = 0; // 0 to 100
        let currentSpeed = 5;
        let particles = [];
        let electrons = [];
        let textEffects = []; // Store floating reaction text
        let animationId;
        
        // Configuration
        const LIQUID_COLOR = "rgba(0, 150, 255, 0.4)"; // CuSO4 Blue
        const COPPER_COLOR = "#b87333";
        const KEY_BASE_COLOR = "#C0C0C0"; // Silver
        const WIRE_COLOR = "#333";
        
        // Positions based on canvas size (600x450)
        const BEAKER_X = 150;
        const BEAKER_Y = 180;
        const BEAKER_W = 300;
        const BEAKER_H = 220; // Bottom is 400. Liquid surface starts drawing at 200.
        
        const ANODE_X = 200; // Left electrode (Copper bar)
        const ANODE_Y_START = 120;
        // Anode length: Covers the active zone well.
        // Active zone ends at 340. Anode ends at 380. That works.
        const ANODE_H = 260; 
        const ANODE_MAX_W = 40;
        
        const CATHODE_X = 400; // Right electrode (Key)
        
        // Adjusted Key Position based on NEW constraints:
        // Liquid Surface: Y = 200
        // Liquid Bottom: Y = 400
        // Top Limit (3cm ~ 60px from surface): Y = 200 + 60 = 260
        // Bottom Limit (3cm ~ 60px from bottom): Y = 400 - 60 = 340
        // Key centered in active region [260, 340]
        // Center = (260 + 340) / 2 = 300
        const CATHODE_Y_CENTER = 300; 
        
        const BATTERY_X = 300;
        const BATTERY_Y = 50;

        // Initialize
        function init() {
            reset();
            animate();
        }

        function reset() {
            isRunning = false;
            progress = 0;
            particles = [];
            electrons = [];
            textEffects = [];
            btnStart.textContent = "Bắt đầu";
            btnStart.classList.remove('bg-red-600', 'hover:bg-red-700');
            btnStart.classList.add('bg-green-600', 'hover:bg-green-700');
            statusText.textContent = "Sẵn sàng...";
            updateUI();
        }

        function toggleSim() {
            isRunning = !isRunning;
            if (isRunning) {
                btnStart.textContent = "Dừng";
                btnStart.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnStart.classList.add('bg-red-600', 'hover:bg-red-700');
                statusText.textContent = "Đang điện phân...";
                spawnParticles();
            } else {
                btnStart.textContent = "Tiếp tục";
                btnStart.classList.remove('bg-red-600', 'hover:bg-red-700');
                btnStart.classList.add('bg-green-600', 'hover:bg-green-700');
                statusText.textContent = "Tạm dừng";
            }
        }

        function spawnParticles() {
            // Rate depends on current - GIẢM SỐ LƯỢNG HẠT
            const spawnRate = 0.08 * (currentSpeed/5);

            // Spawn Cu2+ ions near anode - STRICT ZONE [260, 340]
            // Top Limit (3cm from surface) = 260
            // Bottom Limit (3cm from bottom) = 340
            // Range height = 80px
            if (Math.random() < spawnRate) {
                particles.push({
                    x: ANODE_X + Math.random() * 20, 
                    // Spawn random Y between 260 and 340
                    y: 260 + Math.random() * 80, 
                    // GIẢM TỐC ĐỘ ION trong dung dịch
                    vx: (Math.random() * 0.3 + 0.1) * (currentSpeed/5), 
                    vy: (Math.random() - 0.5) * 0.2,
                    life: 300 
                });

                // Occasionally show Oxidation reaction at Anode (Centered in active zone)
                if (Math.random() < 0.15) {
                    textEffects.push({
                        x: ANODE_X - 60,
                        y: 280 + Math.random() * 40, // Within [260, 340]
                        text: "Cu → Cu²⁺ + 2e⁻",
                        color: "#b91c1c", // Red
                        life: 60,
                        vy: -0.5
                    });
                }
            }
            
            // Spawn electrons on wire (Yellow dots) - GIẢM SỐ LƯỢNG VÀ TỐC ĐỘ
            if (Math.random() < 0.1 * (currentSpeed/5)) { 
                electrons.push({
                    path: 'anode_to_batt',
                    progress: 0,
                    speed: 0.0015 * (currentSpeed/5) 
                });
                 electrons.push({
                    path: 'batt_to_cathode',
                    progress: 0,
                    speed: 0.0015 * (currentSpeed/5) 
                });
            }
        }

        function update() {
            if (!isRunning) return;

            if (progress < 100) {
                progress += 0.02 * currentSpeed;
            } else {
                progress = 100;
                isRunning = false;
                statusText.textContent = "Hoàn thành!";
                btnStart.textContent = "Hoàn thành";
                btnStart.disabled = true;
                btnStart.classList.add('opacity-50', 'cursor-not-allowed');
            }

            spawnParticles();

            // Update Ions (Cu2+)
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                
                // If it hits the cathode area
                if (p.x >= CATHODE_X - 15) {
                    // Occasionally show Reduction reaction at Cathode upon impact
                    if (Math.random() < 0.15) {
                        textEffects.push({
                            x: CATHODE_X + 25,
                            y: p.y,
                            text: "Cu²⁺ + 2e⁻ → Cu",
                            color: "#1e3a8a", // Blue
                            life: 60,
                            vy: -0.5
                        });
                    }
                    particles.splice(i, 1); // Absorb
                }
            }
            
            // Update Electrons
            for (let i = electrons.length - 1; i >= 0; i--) {
                let e = electrons[i];
                e.progress += e.speed;
                if (e.progress >= 1) electrons.splice(i, 1);
            }

            // Update Text Effects
            for (let i = textEffects.length - 1; i >= 0; i--) {
                let t = textEffects[i];
                t.y += t.vy;
                t.life--;
                if (t.life <= 0) textEffects.splice(i, 1);
            }

            updateUI();
        }

        function updateUI() {
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.floor(progress)}%`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Wires
            ctx.beginPath();
            ctx.strokeStyle = WIRE_COLOR;
            ctx.lineWidth = 4;
            
            // Left Wire (Anode to Battery)
            ctx.moveTo(ANODE_X + 10, ANODE_Y_START); 
            ctx.lineTo(ANODE_X + 10, 80);
            ctx.lineTo(BATTERY_X - 20, 80);
            ctx.lineTo(BATTERY_X - 20, 65);
            
            // Right Wire (Cathode to Battery)
            ctx.moveTo(BATTERY_X + 20, 65);
            ctx.lineTo(BATTERY_X + 20, 80);
            ctx.lineTo(CATHODE_X, 80);
            ctx.lineTo(CATHODE_X, CATHODE_Y_CENTER - 45); // Deep into beaker
            
            ctx.stroke();

            // Draw "Clip" holding the key
            ctx.fillStyle = "#555";
            ctx.fillRect(CATHODE_X - 5, CATHODE_Y_CENTER - 50, 10, 15);

            // 2. Battery Symbol
            ctx.fillStyle = "#333";
            ctx.fillRect(BATTERY_X - 30, 45, 20, 20); 
            ctx.fillRect(BATTERY_X + 10, 50, 20, 10);
            
            ctx.beginPath();
            ctx.lineWidth = 3;
            // Positive (+)
            ctx.moveTo(BATTERY_X - 5, 40); ctx.lineTo(BATTERY_X - 5, 70); 
            ctx.font = "bold 20px Arial";
            ctx.fillStyle = "red";
            ctx.fillText("+", BATTERY_X - 25, 35);
            // Negative (-)
            ctx.moveTo(BATTERY_X + 5, 48); ctx.lineTo(BATTERY_X + 5, 62);
            ctx.fillStyle = "black";
            ctx.fillText("-", BATTERY_X + 10, 35);
            ctx.stroke();

            // 3. Beaker & Liquid
            ctx.fillStyle = LIQUID_COLOR;
            ctx.fillRect(BEAKER_X + 10, BEAKER_Y + 20, BEAKER_W - 20, BEAKER_H - 30);
            
            ctx.strokeStyle = "#aaa";
            ctx.lineWidth = 5;
            ctx.lineJoin = "round";
            ctx.beginPath();
            ctx.moveTo(BEAKER_X, BEAKER_Y);
            ctx.lineTo(BEAKER_X, BEAKER_Y + BEAKER_H);
            ctx.quadraticCurveTo(BEAKER_X + BEAKER_W / 2, BEAKER_Y + BEAKER_H + 20, BEAKER_X + BEAKER_W, BEAKER_Y + BEAKER_H);
            ctx.lineTo(BEAKER_X + BEAKER_W, BEAKER_Y);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.ellipse(BEAKER_X + BEAKER_W/2, BEAKER_Y, BEAKER_W/2, 10, 0, 0, 2 * Math.PI);
            ctx.stroke();

            // 4. Anode (Copper Bar) - Now very long
            const currentAnodeWidth = ANODE_MAX_W * (1 - (progress * 0.4 / 100)); 
            ctx.fillStyle = COPPER_COLOR;
            const anodeXOffset = (ANODE_MAX_W - currentAnodeWidth) / 2;
            ctx.fillRect(ANODE_X + anodeXOffset, ANODE_Y_START, currentAnodeWidth, ANODE_H);
            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.fillRect(ANODE_X + anodeXOffset + 2, ANODE_Y_START, 5, ANODE_H);

            // 5. Cathode (Key) - Positioned in the active zone
            drawKey(CATHODE_X, CATHODE_Y_CENTER, progress);

            // 6. Particles (Ions Cu2+)
            ctx.fillStyle = "blue";
            for (let p of particles) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            }

            // 7. Electrons (e-) flow
            ctx.fillStyle = "#FFD700"; 
            for (let e of electrons) {
                let ex, ey;
                if (e.path === 'anode_to_batt') {
                    if (e.progress < 0.5) {
                        ex = ANODE_X + 10;
                        ey = ANODE_Y_START - (e.progress * 2 * (ANODE_Y_START - 80)); 
                    } else {
                        ex = (ANODE_X + 10) + ((e.progress - 0.5) * 2 * ((BATTERY_X - 20) - (ANODE_X + 10)));
                        ey = 80;
                    }
                } else {
                    // Right wire goes DEEP now
                    const cornerX = CATHODE_X;
                    const cornerY = 80;
                    const endY = CATHODE_Y_CENTER - 45;
                    // Recalculate split point based on geometry
                    // Horiz: 80px. Vert: (300-45 - 80) = 175px. Total ~ 255
                    const splitPoint = 80 / 255; 

                    if (e.progress < splitPoint) {
                        let p = e.progress / splitPoint;
                        ex = (BATTERY_X + 20) + (p * (cornerX - (BATTERY_X + 20)));
                        ey = cornerY;
                    } else {
                        let p = (e.progress - splitPoint) / (1 - splitPoint);
                        ex = cornerX;
                        ey = cornerY + (p * (endY - cornerY));
                    }
                }
                ctx.beginPath();
                ctx.arc(ex, ey, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            // 8. Text Effects (Reaction equations)
            ctx.font = "bold 14px Arial";
            for (let t of textEffects) {
                ctx.fillStyle = t.color;
                ctx.globalAlpha = t.life / 60; // Fade out
                ctx.fillText(t.text, t.x, t.y);
                ctx.globalAlpha = 1.0;
            }
        }

        function drawKey(x, y, platingPercent) {
            ctx.save();
            ctx.translate(x, y);
            
            function traceKey() {
                ctx.beginPath();
                // Head
                ctx.arc(0, -40, 20, 0, Math.PI * 2);
                ctx.moveTo(5, -45);
                ctx.arc(0, -45, 5, 0, Math.PI * 2, true);
                // Shaft
                ctx.rect(-6, -20, 12, 100);
                // Teeth
                ctx.rect(-6, 40, 20, 10);
                ctx.rect(-6, 60, 16, 10);
            }

            // 1. Draw Base Key
            ctx.fillStyle = KEY_BASE_COLOR;
            traceKey();
            ctx.fill();
            ctx.strokeStyle = "#999";
            ctx.lineWidth = 1;
            ctx.stroke();

            // 2. Draw Copper Layer
            if (platingPercent > 0) {
                ctx.fillStyle = COPPER_COLOR;
                ctx.globalAlpha = Math.min(1, platingPercent / 80);
                traceKey();
                ctx.fill();
                
                ctx.strokeStyle = "rgba(255, 200, 150, 0.5)";
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            ctx.restore();
        }

        function animate() {
            update();
            draw();
            animationId = requestAnimationFrame(animate);
        }

        // Event Listeners
        btnStart.addEventListener('click', toggleSim);
        
        btnReset.addEventListener('click', () => {
            reset();
            btnStart.disabled = false;
            btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
        });

        rangeCurrent.addEventListener('input', (e) => {
            currentSpeed = parseInt(e.target.value);
            currentValDisplay.textContent = currentSpeed + "A";
        });

        // Start loop
        init();

    </script>
</body>
</html>
